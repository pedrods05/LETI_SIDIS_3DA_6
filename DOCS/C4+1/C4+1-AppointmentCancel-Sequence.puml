@startuml
' C4+1 — Appointment cancel SD (layered)
skinparam dpi 150
skinparam shadowing false
skinparam DefaultFontName Arial

title C4: Sequence Diagram - Appointment Cancel (Physicians → AppointmentRecords)

actor Client
participant "AppointmentController (Physicians)" as Controller
participant "AppointmentService (Physicians)" as Service
participant "AppointmentRepository (Physicians)" as Repo
participant "Appointment Records API" as Records

autonumber
Client -> Controller : PUT /appointments/{id}/cancel
activate Controller
Controller -> Service : cancelAppointment(id)
activate Service
Service -> Records : PUT /api/appointments/internal/{id}/cancel\n(forward Authorization, X-User-Id)
activate Records
alt Records accepted
  Records --> Service : 200 OK { cancelled }
  deactivate Records
  Service -> Repo : findById(id)
  activate Repo
  alt Local exists
    Repo --> Service : Appointment
    deactivate Repo
    Service -> Repo : save(status=CANCELLED)
    activate Repo
    Repo --> Service : persisted
    deactivate Repo
    Service --> Controller : 200 OK { cancelled }
    deactivate Service
    Controller --> Client : 200 OK { cancelled }
    deactivate Controller
  else Local not found
    ' no local row: still return 200 based on records
    deactivate Repo
    Service --> Controller : 200 OK { cancelled }
    deactivate Service
    Controller --> Client : 200 OK { cancelled }
    deactivate Controller
  end
else Records says Not Found (404)
  Records --> Service : 404 Not Found
  deactivate Records
  ' Fallback: local-only cancel if exists
  Service -> Repo : findById(id)
  activate Repo
  alt Local exists
    Repo --> Service : Appointment
    deactivate Repo
    Service -> Repo : save(status=CANCELLED)
    activate Repo
    Repo --> Service : persisted
    deactivate Repo
    Service --> Controller : 200 OK { cancelled (local) }
    deactivate Service
    Controller --> Client : 200 OK { cancelled (local) }
    deactivate Controller
  else Local not found
    ' no explicit null return
    deactivate Repo
    Service --> Controller : 404 Not Found
    deactivate Service
    Controller --> Client : 404 Not Found
    deactivate Controller
  end
else Records error (5xx/timeout)
  Records --> Service : error
  deactivate Records
  Service --> Controller : 502 Bad Gateway
  deactivate Service
  Controller --> Client : 502 Bad Gateway
  deactivate Controller
end

@enduml
