@startuml
skinparam dpi 150
skinparam shadowing false
skinparam DefaultFontName Arial

title C4: Sequence Diagram - Create Appointment (Public)

actor Client
participant "AppointmentController" as Controller
participant "AppointmentService" as Service
participant "PhysicianRepository" as PhysicianRepo
participant "ExternalServiceClient" as ExtClient
participant "AppointmentRepository" as ApptRepo

Client -> Controller : POST /api/appointments\nScheduleAppointmentRequest (appointmentDTO)
activate Controller

Controller -> Service : createAppointment(appointmentDTO)
activate Service

Service -> PhysicianRepo : findById(dto.physicianId)
activate PhysicianRepo
alt Physician found
  PhysicianRepo --> Service : Optional<Physician> (present)
  deactivate PhysicianRepo
else Physician not found
  PhysicianRepo --> Service : Optional.empty
  deactivate PhysicianRepo
  Service -> Service : throw RuntimeException("Physician not found")
  Service --> Controller : RuntimeException
  deactivate Service
  Controller --> Client : 400 Bad Request\n{ "error": "Physician not found" }
  deactivate Controller
  return
end

Service -> ExtClient : createAppointmentInRecords(appointmentData)
activate ExtClient
alt Created in records (OK)
  ExtClient --> Service : 201/200
  deactivate ExtClient

  Service -> Service : Appointment.builder(...)\n.set fields (+wasRescheduled=false)

  Service -> ExtClient : getPatientById(dto.patientId)
  activate ExtClient
  alt Patient data fetched
    ExtClient --> Service : { fullName, email, phoneNumber }
    deactivate ExtClient
    Service -> Service : set patientName/email/phone
  else Failure fetching patient
    ExtClient --> Service : Exception
    deactivate ExtClient
    Service -> Service : log warning("Could not fetch patient data ...")
  end

  Service -> ApptRepo : save(appointment)
  activate ApptRepo
  ApptRepo --> Service : Appointment (created)
  deactivate ApptRepo

  Service --> Controller : Appointment (created)
  deactivate Service
  Controller --> Client : 200 OK\n{ createdAppointment }
  deactivate Controller

else MicroserviceCommunicationException
  ExtClient --> Service : throws MicroserviceCommunicationException(msg)
  deactivate ExtClient

  alt msg contains "conflict" or "exists"
    Service -> Service : throw RuntimeException("Physician already has an appointment\nor appointment ID exists")
  else Other microservice error
    Service -> Service : throw RuntimeException("Failed to create appointment: " + msg)
  end

  Service --> Controller : RuntimeException
  deactivate Service
  Controller --> Client : 400 Bad Request\n{ "error": mapped message }
  deactivate Controller
end

@enduml
