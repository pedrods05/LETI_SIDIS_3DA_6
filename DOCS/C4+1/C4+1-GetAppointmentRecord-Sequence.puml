@startuml
' C4+1 — Get Appointment Record (layered)
skinparam dpi 150
skinparam shadowing false
skinparam DefaultFontName Arial

title C4: Sequence Diagram - Get Appointment Record

actor "Client" as C
participant "Spring Security" as SEC
participant "AppointmentRecordController" as ARC
participant "AppointmentRecordService" as ARS
participant "hap-physicians API" as HPHY #lightblue
participant "hap-patients API" as HPAT #lightblue
participant "Peer AppointmentRecordController" as ARC_PEER #lightgray

autonumber
activate C
' ---- Request & Security Gate ----
C -> ARC : GET /api/appointment-records/{recordId}\nAuthorization, X-User-Id, X-User-Role
activate ARC
ARC -> SEC : hasAnyAuthority('ADMIN','PATIENT') ?
activate SEC
alt Authorized
  SEC --> ARC : allow
  deactivate SEC
else Not authorized
  SEC --> C : 403 Forbidden + {"error": "..."}\n(Spring Security)
  deactivate SEC
  deactivate ARC
  return
end

' ---- Build current user ----
ARC -> ARC : build UserDTO(id=X-User-Id, role=X-User-Role)

' ---- Controller -> Service ----
ARC -> ARS : getAppointmentRecord(recordId, currentUser)
activate ARS

' ---- (Service) External lookups/validations ----
' 1) Verifica permissões/ownership e enriquece dados via serviços externos
ARS -> HPHY : (ex) GET /physicians/{physicianId}\n(validar acesso/metadata)
activate HPHY
HPHY --> ARS : 200 OK / 404 / 403
deactivate HPHY

ARS -> HPAT : (ex) GET /patients/{patientId}\n(validar ownership/consent)
activate HPAT
HPAT --> ARS : 200 OK / 404 / 403
deactivate HPAT

' ---- Outcomes do service mapeados pelo controller ----
alt Record found
  ARS --> ARC : AppointmentRecordViewDTO
  deactivate ARS
  ARC --> C : 200 OK + AppointmentRecordViewDTO
  deactivate ARC
else NotFoundException
  ARS --> ARC : throw NotFoundException(msg)
  deactivate ARS

  ' ---- Anti-loop guard ----
  alt Request tem "X-Peer-Request"
    ARC --> C : 404 Not Found + {"error": msg}
    deactivate ARC
  else Sem "X-Peer-Request" -> tentar peers
    ' Preparar cabeçalhos reencaminhados: Authorization, X-User-Id, X-User-Role, X-Peer-Request=true
    loop para cada peer em ExternalServiceClient.getPeerUrls()
      ARC -> ARC_PEER : HTTP GET /api/appointment-records/{recordId}\n(fwd Authorization, X-User-Id, X-User-Role, X-Peer-Request=true)
      activate ARC_PEER
      alt Peer tem o registo
        ARC_PEER --> ARC : 200 OK + AppointmentRecordViewDTO
        deactivate ARC_PEER
        ARC --> C : 200 OK + AppointmentRecordViewDTO
        deactivate ARC
        break
      else Peer responde 404
        ARC_PEER --> ARC : 404 Not Found
        deactivate ARC_PEER
        ' continua para próximo peer
      else Peer erro (timeout/5xx)
        ARC_PEER --> ARC : error (ignored)
        deactivate ARC_PEER
        ' continua para próximo peer
      end
    end
    ' Nenhum peer devolveu sucesso
    ARC --> C : 404 Not Found + {"error": msg}
    deactivate ARC
  end

else UnauthorizedException
  ARS --> ARC : throw UnauthorizedException(msg)
  deactivate ARS
  ARC --> C : 403 Forbidden + {"error": msg}
  deactivate ARC

else Unexpected Exception
  ARS --> ARC : throw Exception(e)
  deactivate ARS
  ARC --> C : 500 Internal Server Error\n+ {"error": "External service communication error: ..."}
  deactivate ARC
end

@enduml
