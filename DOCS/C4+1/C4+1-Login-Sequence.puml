@startuml
' C4+1 — Login SD (Atualizado segundo implementação real)
skinparam dpi 150
skinparam shadowing false
skinparam DefaultFontName Arial

title C4: Sequence Diagram - Login (Public)

actor User
participant "AuthApi (Controller)" as Controller
participant "AuthService" as AuthService
participant "AuthenticationManager" as AuthManager
participant "UserDetailsService /\nUserInMemoryRepository" as UserStore

activate User
User -> Controller : POST /api/public/login { username, password }
activate Controller
alt Validation error (Bean Validation)
  Controller --> User : 400 Bad Request (validation details)
  deactivate Controller
else Attempt authentication
  Controller -> AuthService : authenticate(username, password)
  activate AuthService
  AuthService -> AuthManager : authenticate(UsernamePasswordAuthenticationToken)
  activate AuthManager
  AuthManager -> UserStore : loadUserByUsername(username) / findByUsername()
  activate UserStore
  alt User exists
    UserStore --> AuthManager : UserDetails (username, passwordHash, roles)
    deactivate UserStore
    AuthManager --> AuthService : Authentication (principal User)
    deactivate AuthManager
    AuthService -> AuthService : generateToken()
    AuthService --> Controller : jwt token
    deactivate AuthService
    Controller --> User : 200 OK { token, roles }
    deactivate Controller
  else User not found OR bad password
    UserStore --> AuthManager : throws UsernameNotFoundException / returns null
    deactivate UserStore
    AuthManager --> AuthService : AuthenticationException
    deactivate AuthManager
    AuthService --> Controller : auth failed
    deactivate AuthService
    Controller --> User : 401 Invalid username or password
    deactivate Controller
  end
end

note right of AuthService
A chamada direta a findByUsername() não ocorre no AuthApi.
O AuthenticationManager delega para UserDetailsService
que internamente usa UserInMemoryRepository.findByUsername.
end note

@enduml
