name: HAP Microservices CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [hap-patients, hap-appointmentrecords, hap-physicians, hap-auth]

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 1. Compilar e Correr Testes Unitários/Integração
      - name: Build and Test with Maven
        run: |
          cd ${{ matrix.service }}
          mvn clean verify

      # 2. Construir Imagem Docker (Só se os testes passarem)
      - name: Build Docker Image
        if: success()
        run: |
          cd ${{ matrix.service }}
          docker build -t ${{ matrix.service }}:latest .

      # 3. Scan de Segurança (Requisito Aula 11 - Trivy)
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ matrix.service }}:latest'
          format: 'table'
          exit-code: '0' # Muda para 1 se quiseres que falhe em vulnerabilidades críticas
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      # Optional: switch traffic weights (blue/green) after deploy
      - name: Switch traffic to green (manual trigger)
        if: success() && matrix.service == 'hap-appointmentrecords' && false
        run: |
          pwsh ./scripts/switch-appointmentrecords-traffic.ps1 -BlueWeight 0 -GreenWeight 100

    # 4. Login & Push para Docker Hub (Opcional - Requer Secrets no GitHub)
    # Descomenta se quiseres enviar para o Docker Hub real
    # - name: Login to Docker Hub
    #   if: github.event_name != 'pull_request'
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKERHUB_USERNAME }}
    #     password: ${{ secrets.DOCKERHUB_TOKEN }}
    #
    # - name: Push to Docker Hub
    #   if: github.event_name != 'pull_request'
    #   run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service }}:latest