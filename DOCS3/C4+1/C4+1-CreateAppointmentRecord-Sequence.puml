@startuml
' C4+1 — Create Appointment Record (aligned with code) v3
skinparam dpi 150
skinparam shadowing false
skinparam DefaultFontName Arial

title C4: Sequence Diagram - Create Appointment Record v3\n(With Resilience & Observability)

actor "Physician Client" as C
participant "Spring Security\n(@PreAuthorize)" as SEC
participant "AppointmentRecordController" as ARC
participant "AppointmentRecordService" as ARS
participant "ExternalServiceClient\n(@CircuitBreaker, @Retry)" as ExternalClient
participant "hap-physicians API (external)\n(mTLS + JWT)" as HPHY
participant "MongoDB (Write Model)" as MONGO_W
participant "MongoDB (Projection Read Model)" as MONGO_R
participant "RabbitMQ Exchange" as RMQ

autonumber
activate C

note over C, RMQ
  **Assignment 3 Features:**
  • Security: JWT (@PreAuthorize), mTLS, RBAC
  • Resilience: Circuit Breaker, Retry
  • Observability: Zipkin (tracing), Prometheus (metrics), ELK (logs)
  • Correlation ID: End-to-end traceability
end note

' ---- Request & Security Gate ----
C -> ARC : POST /api/appointment-records/{appointmentId}/record\nAuthorization, X-User-Id (physicianId), body: AppointmentRecordRequest
activate ARC

ARC -> SEC : hasAuthority('PHYSICIAN') ?
activate SEC
alt Authorized
  SEC --> ARC : allow
  deactivate SEC
else Not authorized
  SEC --> C : 403 Forbidden + {"error": "..."}\n(Spring Security)
  deactivate SEC
  deactivate ARC
  return
end

' ---- Controller -> Service ----
activate ARC
ARC -> ARS : createRecord(appointmentId, request, physicianId)\n[Trace ID propagated]
activate ARS

' ---- External validation & normalization ----
ARS -> ExternalClient: getAppointment(appointmentId)\n[Circuit Breaker + Retry + mTLS]
activate ExternalClient

note right of ExternalClient
  Circuit Breaker checks state
  Retry with exponential backoff
  Metrics sent to Prometheus
  Trace sent to Zipkin
end note

ExternalClient -> HPHY : GET /appointments/{appointmentId}\n(+ Authorization header, mTLS + JWT)
activate HPHY
alt Appointment exists
  HPHY --> ExternalClient : 200 OK + { patientId, physicianId | physician: { physicianId } }
  deactivate HPHY
  ExternalClient --> ARS : Appointment data
else Appointment not found
  HPHY --> ExternalClient : 404 Not Found
  deactivate HPHY
  ExternalClient --> ARS : NotFoundException
else Timeout/Error
  HPHY --> ExternalClient : Timeout/Error
  deactivate HPHY
  ExternalClient --> ARS : Exception
end

deactivate ExternalClient

ARS -> ARS : normalize physicianId if nested under physician{}
ARS -> ARS : if appointmentPhysicianId != physicianId -> throw UnauthorizedException
ARS -> ARS : if record exists for appointmentId -> throw IllegalStateException (conflict)
ARS -> ARS : if patientId missing -> throw NotFoundException

' ---- Persist write model ----
ARS -> MONGO_W : save AppointmentRecord(recordId, appointmentId, diagnosis, ...)
MONGO_W --> ARS : ack

' ---- Persist projection read model ----
ARS -> MONGO_R : save AppointmentRecordProjection(recordId, appointmentId, patientId, physicianId, diagnosis, ...)
MONGO_R --> ARS : ack

' ---- Publish event via RabbitMQ ----
ARS -> RMQ : publish AppointmentRecordCreatedEvent(recordId, appointmentId, patientId, physicianId, timestamp)\n[Retry on failure]
activate RMQ

note right of RMQ
  AMQP publishing:
  • Retry on failure
  • Metrics to Prometheus
  • Correlation ID in message
end note

RMQ --> ARS : ack
deactivate RMQ

' ---- Outcomes mapped às exceções/HTTP do controller ----
alt Created successfully
  ARS --> ARC : AppointmentRecordResponse(recordId, appointmentId, message)
  deactivate ARS
  ARC --> C : 201 Created + AppointmentRecordResponse
else NotFoundException
  ARS --> ARC : throw NotFoundException(msg)
  deactivate ARS
  ARC --> C : 404 Not Found + {"error": msg}
else UnauthorizedException
  ARS --> ARC : throw UnauthorizedException(msg)
  deactivate ARS
  ARC --> C : 403 Forbidden + {"error": msg}
else IllegalStateException (conflict)
  ARS --> ARC : throw IllegalStateException(msg)
  deactivate ARS
  ARC --> C : 409 Conflict + {"error": msg}
else Unexpected Exception
  ARS --> ARC : throw Exception(e)
  deactivate ARS
  ARC --> C : 500 Internal Server Error\n+ {"error": "External service communication error: ..."}
  deactivate ARC
end

@enduml
