<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="1664px" preserveAspectRatio="none" style="width:1523px;height:1664px;background:#FFFFFF;" version="1.1" viewBox="0 0 1523 1664" width="1523px" zoomAndPan="magnify"><title>Add Note to Appointment - Sequence Diagram</title><defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="308.0137" x="608.8372" y="30.1074">Add Note to Appointment - Sequence Diagram</text><g><title>Client</title><rect fill="#FFFFFF" height="1317.1152" style="stroke:#181818;stroke-width:1;" width="10" x="45.8965" y="133.2422"/></g><g><title>AppointmentController</title><rect fill="#FFFFFF" height="1293.8242" style="stroke:#181818;stroke-width:1;" width="10" x="336.897" y="156.5332"/></g><g><title>AppointmentCommandService</title><rect fill="#FFFFFF" height="729.6152" style="stroke:#181818;stroke-width:1;" width="10" x="681.3701" y="473.7832"/></g><g><title>AppointmentRepository</title><rect fill="#FFFFFF" height="31.291" style="stroke:#181818;stroke-width:1;" width="10" x="947.7397" y="505.0742"/></g><g><title>EventStoreService</title><rect fill="#FFFFFF" height="306.6191" style="stroke:#181818;stroke-width:1;" width="10" x="1102.4736" y="865.4883"/></g><g><title>EventStoreRepository</title><rect fill="#FFFFFF" height="31.291" style="stroke:#181818;stroke-width:1;" width="10" x="1416.5986" y="896.7793"/></g><g><title>EventStoreRepository</title><rect fill="#FFFFFF" height="31.291" style="stroke:#181818;stroke-width:1;" width="10" x="1416.5986" y="1109.5254"/></g><rect fill="none" height="900.9922" style="stroke:#000000;stroke-width:1.5;" width="1506.688" x="10" y="365.9883"/><rect fill="none" height="708.6152" style="stroke:#000000;stroke-width:1.5;" width="1486.688" x="20" y="551.3652"/><rect fill="none" height="115.7949" style="stroke:#000000;stroke-width:1.5;" width="408.5449" x="20" y="1280.9805"/><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="1458.5703" width="8" x="46.8965" y="123.2422"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="50" x2="50" y1="123.2422" y2="1581.8125"/></g><g><title>AppointmentController</title><rect fill="#000000" fill-opacity="0.00000" height="1458.5703" width="8" x="337.897" y="123.2422"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="341.249" x2="341.249" y1="123.2422" y2="1581.8125"/></g><g><title>AppointmentCommandService</title><rect fill="#000000" fill-opacity="0.00000" height="1458.5703" width="8" x="682.3701" y="123.2422"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="685.436" x2="685.436" y1="123.2422" y2="1581.8125"/></g><g><title>AppointmentRepository</title><rect fill="#000000" fill-opacity="0.00000" height="1458.5703" width="8" x="948.7397" y="123.2422"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="951.978" x2="951.978" y1="123.2422" y2="1581.8125"/></g><g><title>EventStoreService</title><rect fill="#000000" fill-opacity="0.00000" height="1458.5703" width="8" x="1103.4736" y="123.2422"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="1106.5015" x2="1106.5015" y1="123.2422" y2="1581.8125"/></g><g><title>EventStoreRepository</title><rect fill="#000000" fill-opacity="0.00000" height="1458.5703" width="8" x="1417.5986" y="123.2422"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="1421.5093" x2="1421.5093" y1="123.2422" y2="1581.8125"/></g><g class="participant participant-head" data-participant="Client"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="35.793" x="30" y="119.7285">Client</text><ellipse cx="50.8965" cy="53.1211" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M50.8965,61.1211 L50.8965,88.1211 M37.8965,69.1211 L63.8965,69.1211 M50.8965,88.1211 L37.8965,103.1211 M50.8965,88.1211 L63.8965,103.1211" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="Client"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="35.793" x="30" y="1595.9199">Client</text><ellipse cx="50.8965" cy="1607.9336" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M50.8965,1615.9336 L50.8965,1642.9336 M37.8965,1623.9336 L63.8965,1623.9336 M50.8965,1642.9336 L37.8965,1657.9336 M50.8965,1642.9336 L63.8965,1657.9336" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="Controller"><rect fill="#E2E2F0" height="32.6211" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="153.2959" x="265.249" y="89.6211"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139.2959" x="272.249" y="111.7285">AppointmentController</text></g><g class="participant participant-tail" data-participant="Controller"><rect fill="#E2E2F0" height="32.6211" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="153.2959" x="265.249" y="1580.8125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139.2959" x="272.249" y="1602.9199">AppointmentController</text></g><g class="participant participant-head" data-participant="CommandService"><rect fill="#E2E2F0" height="32.6211" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="203.8682" x="584.436" y="89.6211"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="189.8682" x="591.436" y="111.7285">AppointmentCommandService</text></g><g class="participant participant-tail" data-participant="CommandService"><rect fill="#E2E2F0" height="32.6211" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="203.8682" x="584.436" y="1580.8125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="189.8682" x="591.436" y="1602.9199">AppointmentCommandService</text></g><g class="participant participant-head" data-participant="WriteRepo"><rect fill="#E2E2F0" height="51.2422" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="159.5234" x="872.978" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145.5234" x="879.978" y="93.1074">AppointmentRepository</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114.3447" x="895.5674" y="111.7285">(Write Model - H2)</text></g><g class="participant participant-tail" data-participant="WriteRepo"><rect fill="#E2E2F0" height="51.2422" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="159.5234" x="872.978" y="1580.8125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="145.5234" x="879.978" y="1602.9199">AppointmentRepository</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114.3447" x="895.5674" y="1621.541">(Write Model - H2)</text></g><g class="participant participant-head" data-participant="EventStoreService"><rect fill="#E2E2F0" height="32.6211" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129.9443" x="1042.5015" y="89.6211"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.9443" x="1049.5015" y="111.7285">EventStoreService</text></g><g class="participant participant-tail" data-participant="EventStoreService"><rect fill="#E2E2F0" height="32.6211" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129.9443" x="1042.5015" y="1580.8125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.9443" x="1049.5015" y="1602.9199">EventStoreService</text></g><g class="participant participant-head" data-participant="EventStoreRepo"><rect fill="#E2E2F0" height="51.2422" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="150.1787" x="1346.5093" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="136.1787" x="1353.5093" y="93.1074">EventStoreRepository</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112.8135" x="1365.1919" y="111.7285">(Event Store - H2)</text></g><g class="participant participant-tail" data-participant="EventStoreRepo"><rect fill="#E2E2F0" height="51.2422" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="150.1787" x="1346.5093" y="1580.8125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="136.1787" x="1353.5093" y="1602.9199">EventStoreRepository</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112.8135" x="1365.1919" y="1621.541">(Event Store - H2)</text></g><g><title>Client</title><rect fill="#FFFFFF" height="1317.1152" style="stroke:#181818;stroke-width:1;" width="10" x="45.8965" y="133.2422"/></g><g><title>AppointmentController</title><rect fill="#FFFFFF" height="1293.8242" style="stroke:#181818;stroke-width:1;" width="10" x="336.897" y="156.5332"/></g><g><title>AppointmentCommandService</title><rect fill="#FFFFFF" height="729.6152" style="stroke:#181818;stroke-width:1;" width="10" x="681.3701" y="473.7832"/></g><g><title>AppointmentRepository</title><rect fill="#FFFFFF" height="31.291" style="stroke:#181818;stroke-width:1;" width="10" x="947.7397" y="505.0742"/></g><g><title>EventStoreService</title><rect fill="#FFFFFF" height="306.6191" style="stroke:#181818;stroke-width:1;" width="10" x="1102.4736" y="865.4883"/></g><g><title>EventStoreRepository</title><rect fill="#FFFFFF" height="31.291" style="stroke:#181818;stroke-width:1;" width="10" x="1416.5986" y="896.7793"/></g><g><title>EventStoreRepository</title><rect fill="#FFFFFF" height="31.291" style="stroke:#181818;stroke-width:1;" width="10" x="1416.5986" y="1109.5254"/></g><g class="message" data-participant-1="Client" data-participant-2="Controller"><polygon fill="#181818" points="324.897,152.5332,334.897,156.5332,324.897,160.5332,328.897,156.5332" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;" x1="55.8965" x2="330.897" y1="156.5332" y2="156.5332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7.23" x="65.3965" y="151.2705">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="250.7705" x="76.6265" y="151.2705">POST /appointments/{appointmentId}/notes</text></g><g class="message" data-participant-1="Controller" data-participant-2="Controller"><line style="stroke:#181818;stroke-width:2;" x1="346.897" x2="388.897" y1="205.1152" y2="205.1152"/><line style="stroke:#181818;stroke-width:2;" x1="388.897" x2="388.897" y1="205.1152" y2="218.1152"/><line style="stroke:#181818;stroke-width:2;" x1="347.897" x2="388.897" y1="218.1152" y2="218.1152"/><polygon fill="#181818" points="357.897,214.1152,347.897,218.1152,357.897,222.1152,353.897,218.1152" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7.23" x="353.897" y="191.207">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195.1016" x="365.127" y="182.5615">Capture correlationId from header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137.998" x="393.6787" y="199.8525">(or generate new UUID)</text></g><g class="message" data-participant-1="Controller" data-participant-2="Controller"><line style="stroke:#181818;stroke-width:2;" x1="346.897" x2="388.897" y1="249.4063" y2="249.4063"/><line style="stroke:#181818;stroke-width:2;" x1="388.897" x2="388.897" y1="249.4063" y2="262.4063"/><line style="stroke:#181818;stroke-width:2;" x1="347.897" x2="388.897" y1="262.4063" y2="262.4063"/><polygon fill="#181818" points="357.897,258.4063,347.897,262.4063,357.897,266.4063,353.897,262.4063" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7.23" x="353.897" y="244.1436">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187.1353" x="365.127" y="244.1436">Put correlationId in MDC context</text></g><g class="message" data-participant-1="Controller" data-participant-2="Controller"><line style="stroke:#181818;stroke-width:2;" x1="346.897" x2="388.897" y1="293.6973" y2="293.6973"/><line style="stroke:#181818;stroke-width:2;" x1="388.897" x2="388.897" y1="293.6973" y2="306.6973"/><line style="stroke:#181818;stroke-width:2;" x1="347.897" x2="388.897" y1="306.6973" y2="306.6973"/><polygon fill="#181818" points="357.897,302.6973,347.897,306.6973,357.897,310.6973,353.897,306.6973" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7.23" x="353.897" y="288.4346">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210.9961" x="365.127" y="288.4346">Extract note and userId from request</text></g><g class="message" data-participant-1="Controller" data-participant-2="Controller"><line style="stroke:#181818;stroke-width:2;" x1="346.897" x2="388.897" y1="337.9883" y2="337.9883"/><line style="stroke:#181818;stroke-width:2;" x1="388.897" x2="388.897" y1="337.9883" y2="350.9883"/><line style="stroke:#181818;stroke-width:2;" x1="347.897" x2="388.897" y1="350.9883" y2="350.9883"/><polygon fill="#181818" points="357.897,346.9883,347.897,350.9883,357.897,354.9883,353.897,350.9883" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7.23" x="353.897" y="332.7256">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149.5889" x="365.127" y="332.7256">Validate note is not empty</text></g><path d="M10,365.9883 L70.1709,365.9883 L70.1709,375.2793 L60.1709,385.2793 L10,385.2793 L10,365.9883" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="900.9922" style="stroke:#000000;stroke-width:1.5;" width="1506.688" x="10" y="365.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="15.1709" x="25" y="381.0166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="79.4546" x="85.1709" y="379.8584">[Note is empty]</text><g class="message" data-participant-1="Controller" data-participant-2="Client"><polygon fill="#181818" points="66.8965,421.8613,56.8965,425.8613,66.8965,429.8613,62.8965,425.8613" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="60.8965" x2="335.897" y1="425.8613" y2="425.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7.23" x="118.6057" y="411.9531">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100.4644" x="151.7795" y="403.3076">400 Bad Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144.3521" x="129.8357" y="420.5986">{error: "Note is required"}</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="10" x2="1516.688" y1="434.8613" y2="434.8613"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="72.123" x="15" y="446.7314">[Note is valid]</text><g class="message" data-participant-1="Controller" data-participant-2="CommandService"><polygon fill="#181818" points="669.3701,469.7832,679.3701,473.7832,669.3701,477.7832,673.3701,473.7832" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;" x1="346.897" x2="675.3701" y1="473.7832" y2="473.7832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7.23" x="356.397" y="468.5205">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="304.2432" x="367.627" y="468.5205">addNoteToAppointment(appointmentId, note, userId)</text></g><g class="message" data-participant-1="CommandService" data-participant-2="WriteRepo"><polygon fill="#181818" points="935.7397,501.0742,945.7397,505.0742,935.7397,509.0742,939.7397,505.0742" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;" x1="691.3701" x2="941.7397" y1="505.0742" y2="505.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7.23" x="744.9282" y="499.8115">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138.0234" x="756.1582" y="499.8115">findById(appointmentId)</text></g><g class="message" data-participant-1="WriteRepo" data-participant-2="CommandService"><polygon fill="#181818" points="702.3701,532.3652,692.3701,536.3652,702.3701,540.3652,698.3701,536.3652" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="696.3701" x2="951.7397" y1="536.3652" y2="536.3652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7.23" x="748.1423" y="531.1025">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136.5952" x="759.3723" y="531.1025">Optional&lt;Appointment&gt;</text></g><path d="M20,551.3652 L80.1709,551.3652 L80.1709,560.6563 L70.1709,570.6563 L20,570.6563 L20,551.3652" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="708.6152" style="stroke:#000000;stroke-width:1.5;" width="1486.688" x="20" y="551.3652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="15.1709" x="35" y="566.3936">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="128.9009" x="95.1709" y="565.2354">[Appointment not found]</text><g class="message" data-participant-1="CommandService" data-participant-2="Controller"><polygon fill="#181818" points="357.897,589.9473,347.897,593.9473,357.897,597.9473,353.897,593.9473" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="351.897" x2="680.3701" y1="593.9473" y2="593.9473"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="377.8013" y="588.6846">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254.2046" x="396.2612" y="588.6846">RuntimeException("Appointment not found")</text></g><g class="message" data-participant-1="Controller" data-participant-2="Client"><polygon fill="#181818" points="66.8965,638.5293,56.8965,642.5293,66.8965,646.5293,62.8965,642.5293" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="60.8965" x2="335.897" y1="642.5293" y2="642.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="95.4653" y="628.6211">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100.4644" x="155.3945" y="619.9756">400 Bad Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183.4028" x="113.9253" y="637.2666">{error: "Appointment not found"}</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="20" x2="1506.688" y1="651.5293" y2="651.5293"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="108.7432" x="25" y="663.3994">[Appointment found]</text><g class="message" data-participant-1="CommandService" data-participant-2="CommandService"><line style="stroke:#181818;stroke-width:2;" x1="691.3701" x2="733.3701" y1="690.4512" y2="690.4512"/><line style="stroke:#181818;stroke-width:2;" x1="733.3701" x2="733.3701" y1="690.4512" y2="703.4512"/><line style="stroke:#181818;stroke-width:2;" x1="692.3701" x2="733.3701" y1="703.4512" y2="703.4512"/><polygon fill="#181818" points="702.3701,699.4512,692.3701,703.4512,702.3701,707.4512,698.3701,703.4512" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="698.3701" y="685.1885">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213.9097" x="716.8301" y="685.1885">Create noteData and metadata Maps</text></g><g class="message" data-participant-1="CommandService" data-participant-2="CommandService"><line style="stroke:#181818;stroke-width:2;" x1="691.3701" x2="733.3701" y1="734.7422" y2="734.7422"/><line style="stroke:#181818;stroke-width:2;" x1="733.3701" x2="733.3701" y1="734.7422" y2="747.7422"/><line style="stroke:#181818;stroke-width:2;" x1="692.3701" x2="733.3701" y1="747.7422" y2="747.7422"/><polygon fill="#181818" points="702.3701,743.7422,692.3701,747.7422,702.3701,751.7422,698.3701,747.7422" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="698.3701" y="729.4795">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158.9326" x="716.8301" y="729.4795">Get correlationId from MDC</text></g><g class="message" data-participant-1="CommandService" data-participant-2="EventStoreService"><polygon fill="#181818" points="1090.4736,861.4883,1100.4736,865.4883,1090.4736,869.4883,1094.4736,865.4883" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;" x1="691.3701" x2="1096.4736" y1="865.4883" y2="865.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="808.5842" y="816.998">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151.0361" x="830.6338" y="773.7705">saveEvent(appointmentId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158.2153" x="827.0442" y="791.0615">EventType.NOTE_ADDED,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56.3735" x="877.9651" y="808.3525">noteData,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75.1499" x="868.5769" y="825.6436">correlationId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="39.7427" x="886.2805" y="842.9346">userId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58.5317" x="876.886" y="860.2256">metadata)</text></g><g class="message" data-participant-1="EventStoreService" data-participant-2="EventStoreRepo"><polygon fill="#181818" points="1404.5986,892.7793,1414.5986,896.7793,1404.5986,900.7793,1408.5986,896.7793" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;" x1="1112.4736" x2="1410.5986" y1="896.7793" y2="896.7793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="1121.9736" y="891.5166">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="266.665" x="1140.4336" y="891.5166">findLastVersionByAggregateId(appointmentId)</text></g><g class="message" data-participant-1="EventStoreRepo" data-participant-2="EventStoreService"><polygon fill="#181818" points="1123.4736,924.0703,1113.4736,928.0703,1123.4736,932.0703,1119.4736,928.0703" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="1117.4736" x2="1420.5986" y1="928.0703" y2="928.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="1199.2712" y="922.8076">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117.0698" x="1217.7312" y="922.8076">Long currentVersion</text></g><g class="message" data-participant-1="EventStoreService" data-participant-2="EventStoreService"><line style="stroke:#181818;stroke-width:2;" x1="1112.4736" x2="1154.4736" y1="959.3613" y2="959.3613"/><line style="stroke:#181818;stroke-width:2;" x1="1154.4736" x2="1154.4736" y1="959.3613" y2="972.3613"/><line style="stroke:#181818;stroke-width:2;" x1="1113.4736" x2="1154.4736" y1="972.3613" y2="972.3613"/><polygon fill="#181818" points="1123.4736,968.3613,1113.4736,972.3613,1123.4736,976.3613,1119.4736,972.3613" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="1119.4736" y="954.0986">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247.8569" x="1137.9336" y="954.0986">Calculate nextVersion = currentVersion + 1</text></g><g class="message" data-participant-1="EventStoreService" data-participant-2="EventStoreService"><line style="stroke:#181818;stroke-width:2;" x1="1112.4736" x2="1154.4736" y1="1020.9434" y2="1020.9434"/><line style="stroke:#181818;stroke-width:2;" x1="1154.4736" x2="1154.4736" y1="1020.9434" y2="1033.9434"/><line style="stroke:#181818;stroke-width:2;" x1="1113.4736" x2="1154.4736" y1="1033.9434" y2="1033.9434"/><polygon fill="#181818" points="1123.4736,1029.9434,1113.4736,1033.9434,1123.4736,1037.9434,1119.4736,1033.9434" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="1119.4736" y="1007.0352">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102.5908" x="1149.1372" y="998.3896">Serialize to JSON</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124.998" x="1137.9336" y="1015.6807">(using ObjectMapper)</text></g><g class="message" data-participant-1="EventStoreService" data-participant-2="EventStoreService"><line style="stroke:#181818;stroke-width:2;" x1="1112.4736" x2="1154.4736" y1="1065.2344" y2="1065.2344"/><line style="stroke:#181818;stroke-width:2;" x1="1154.4736" x2="1154.4736" y1="1065.2344" y2="1078.2344"/><line style="stroke:#181818;stroke-width:2;" x1="1113.4736" x2="1154.4736" y1="1078.2344" y2="1078.2344"/><polygon fill="#181818" points="1123.4736,1074.2344,1113.4736,1078.2344,1123.4736,1082.2344,1119.4736,1078.2344" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="1119.4736" y="1059.9717">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131.5171" x="1137.9336" y="1059.9717">Build EventStore entity</text></g><g class="message" data-participant-1="EventStoreService" data-participant-2="EventStoreRepo"><polygon fill="#181818" points="1404.5986,1105.5254,1414.5986,1109.5254,1404.5986,1113.5254,1408.5986,1109.5254" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;" x1="1112.4736" x2="1410.5986" y1="1109.5254" y2="1109.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="1205.8103" y="1104.2627">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98.9917" x="1224.2703" y="1104.2627">save(eventStore)</text></g><g class="message" data-participant-1="EventStoreRepo" data-participant-2="EventStoreService"><polygon fill="#181818" points="1123.4736,1136.8164,1113.4736,1140.8164,1123.4736,1144.8164,1119.4736,1140.8164" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="1117.4736" x2="1420.5986" y1="1140.8164" y2="1140.8164"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="1202.1689" y="1135.5537">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111.2744" x="1220.6289" y="1135.5537">EventStore (saved)</text></g><g class="message" data-participant-1="EventStoreService" data-participant-2="CommandService"><polygon fill="#181818" points="702.3701,1168.1074,692.3701,1172.1074,702.3701,1176.1074,698.3701,1172.1074" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="696.3701" x2="1106.4736" y1="1172.1074" y2="1172.1074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="858.0347" y="1166.8447">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64.3145" x="876.4946" y="1166.8447">EventStore</text></g><g class="message" data-participant-1="CommandService" data-participant-2="Controller"><polygon fill="#181818" points="357.897,1199.3984,347.897,1203.3984,357.897,1207.3984,353.897,1203.3984" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="351.897" x2="685.3701" y1="1203.3984" y2="1203.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="465.8645" y="1198.1357">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83.0781" x="484.3245" y="1198.1357">void (success)</text></g><g class="message" data-participant-1="Controller" data-participant-2="Client"><polygon fill="#181818" points="66.8965,1247.9805,56.8965,1251.9805,66.8965,1255.9805,62.8965,1251.9805" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="60.8965" x2="335.897" y1="1251.9805" y2="1251.9805"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="77.7681" y="1238.0723">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44.0845" x="183.5845" y="1229.4268">200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218.7974" x="96.228" y="1246.7178">{message: "Note added successfully"}</text></g><path d="M20,1280.9805 L80.1709,1280.9805 L80.1709,1290.2715 L70.1709,1300.2715 L20,1300.2715 L20,1280.9805" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="115.7949" style="stroke:#000000;stroke-width:1.5;" width="408.5449" x="20" y="1280.9805"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="15.1709" x="35" y="1296.0088">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="103.8931" x="95.1709" y="1294.8506">[RuntimeException]</text><g class="message" data-participant-1="Controller" data-participant-2="Client"><polygon fill="#181818" points="66.8965,1336.8535,56.8965,1340.8535,66.8965,1344.8535,62.8965,1340.8535" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="60.8965" x2="335.897" y1="1340.8535" y2="1340.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="109.4841" y="1326.9453">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100.4644" x="155.3945" y="1318.2998">400 Bad Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155.3652" x="127.9441" y="1335.5908">{error: exception message}</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="20" x2="428.5449" y1="1349.8535" y2="1349.8535"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="92.2861" x="25" y="1361.7236">[Other Exception]</text><g class="message" data-participant-1="Controller" data-participant-2="Client"><polygon fill="#181818" points="66.8965,1384.7754,56.8965,1388.7754,66.8965,1392.7754,62.8965,1388.7754" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:2;stroke-dasharray:2,2;" x1="60.8965" x2="335.897" y1="1388.7754" y2="1388.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="115.635" y="1383.5127">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143.0635" x="134.095" y="1383.5127">500 Internal Server Error</text></g><g class="message" data-participant-1="Controller" data-participant-2="Controller"><line style="stroke:#181818;stroke-width:2;" x1="346.897" x2="388.897" y1="1449.3574" y2="1449.3574"/><line style="stroke:#181818;stroke-width:2;" x1="388.897" x2="388.897" y1="1449.3574" y2="1462.3574"/><line style="stroke:#181818;stroke-width:2;" x1="341.897" x2="388.897" y1="1462.3574" y2="1462.3574"/><polygon fill="#181818" points="351.897,1458.3574,341.897,1462.3574,351.897,1466.3574,347.897,1462.3574" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14.46" x="353.897" y="1435.4492">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186.3862" x="372.3569" y="1426.8037">Remove correlationId from MDC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132.9326" x="399.0837" y="1444.0947">(always in finally block)</text></g><path d="M346,1470.3574 L346,1566.3574 L659,1566.3574 L659,1480.3574 L649,1470.3574 L346,1470.3574" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M649,1470.3574 L649,1480.3574 L659,1480.3574 L649,1470.3574" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="268.8042" x="352" y="1489.3857">Este diagrama mostra o processo de adicionar</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="287.625" x="352" y="1506.6768">uma nota a uma consulta usando Event Sourcing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292.6333" x="352" y="1523.9678">A nota &#233; salva como um evento NOTE_ADDED no</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="281.0933" x="352" y="1541.2588">Event Store, permitindo rastreabilidade completa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213.1797" x="352" y="1558.5498">e reconstru&#231;&#227;o do hist&#243;rico de notas.</text><!--SRC=[hLPVRo8t47_VJp6YBw3caclKlg1h90AqfRs4K-2kBv4ginx0ZTVUsbuIUigdwKDrp_q8-M8TUu4riD3ZLAGezkpCR_vwPko3K3apB8C9InzcHXUATxNK1hxw8VmIk-6m-4U1AiKRj9RDi2F5J46Aog6fuUeOen_7Sv4-AEA7ooHnmac43kTmgns2qz39SosKomW3Ni5e9GazmMO4bIGiTMH9LmfYI0ZUYLJaZ9WRaMHNAsUqb6WQm2nKroCIMSOK7w5PY1HNKZ7feEGTvjeACcfvhvg_6a5kt6YEagp_wR8La0BLyss3z1SaFY99ZDNkKGy9RIaEP0ZqIF4sCmMlS5eLsOG2GN4K2qR6ha9P_eDNLr6qsl1kE1h31QkyjHSVezk0FryeIfoDuAfO9zLv5xVBSbUGgQas1YLpGgi1XwdH6SoHSJJa4gLvXWgDHrNu2E_V3tgj8vZl2hU39nJSzBf4f7fySaT4-q_Ea0VWVG7AEHGMpTeWuslG7XF_mAJWmKmlBwp_3vZbRaaXbwwiRIAN9A1VZEN1Gl3RyEthrt3DEDoLAk_LHwGdGneQQmXlZ3386yz9WjBY1dlXRTZ3ljgfuZOmpht8M4SbtDnAwLbmusmLWrR0ZDAxzIXM2cEQLxef-3PCXUBNom7Vrh63MZqGJzxSojZiE33CVNQPV1CvS1NaEDO0beee2N5ZyVcP-huMljRvi9FXkq8vaM7_ASMWljceXMkq8i0JCrmF-1m0GwPZXkF6xmUjQt1TdptcMAZn31tZ_dB3Sdi2re_ewjujlRJa2CfUMsk3PGiCv9twkrU1EbxcU7ux7FT_w_Hw_HwHr-RJSSi0kfV5IeUrLrKcDaMntratF7kVjaskIlaji-u36ajwhvUTsSpWZA3ho_k0yasTRolU57nDfDvgDOEq89VLMli68QhwtNR_cTvLLS9aMiYotpwj5S7tEvhXQ_ZcP6Ww2EfGVuOP__DeU4iDlh22t1fEViVKKGtcQ5eduruNGlBe0z11-BvxKcPz9JPnG_o_qnUPr_IgelhuikpLlCgAwpZsNkd_H-TRQC79wY9DQMMhjRjk91pfW9VK0OU_KEFBofrnFTneC267bQ9f8ULotVoeq_c_C4ft6_4NJLDSIyFAXkTobWxTd20-2_ixmXxuDPScaI_kXHVqwAMfXtU5Eypq0WyqK7eKJ3wofVMh2xKRHb60YTJfGok98rwkR5ivgBQki8GOCPixqDFu2vMIfK-yNAKPPDhIsWCQSgDzq3LbbT90goRDLyzU41EXqRW8HzgZR27fMbZAjuRLpgaBaz93FYU1Jid-yebUb5nuYKoJA8IdfQ5gviIN04HBwndGyy-44nxOK9EbWJKHVgtYFbXPBgclamXvXjuEPugNlr_-8fCrp8LrB_yOaGO7l0NstASXZBlaNm00]--></g></svg>