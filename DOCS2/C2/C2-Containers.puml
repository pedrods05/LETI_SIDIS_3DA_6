@startuml
skinparam dpi 150
skinparam shadowing false
skinparam linetype ortho
skinparam roundcorner 15

skinparam nodesep 110
skinparam ranksep 100

skinparam defaultFontName Arial
skinparam defaultFontSize 13

skinparam rectangle {
    BackgroundColor<<Service>> #88C0D0
    BorderColor<<Service>> #5E81AC
    BackgroundColor<<Infra>> #BF616A
    BorderColor<<Infra>> #4C566A
    BackgroundColor<<Auth>> #EBCB8B
    BorderColor<<Auth>> #D08770
    FontColor #2E3440
}

skinparam database {
    BackgroundColor #A3BE8C
    BorderColor #4C566A
    FontColor #2E3440
}

skinparam arrow {
    Color #4C566A
    Thickness 1.2
}

title **C2 — Containers (HAP)**\nArquitetura v2

' -- Camada 1: Segurança --
rectangle "Auth Service\nPorts: 8084, 8089" as Auth <<Auth>>

' -- Camada 2: Serviços de Negócio --
rectangle "Physicians Service\nPorts: 8081, 8087" as Physicians <<Service>>
rectangle "Patients Service\nPorts: 8082, 8088" as Patients <<Service>>
rectangle "Records Service\nPorts: 8083, 8090" as Records <<Service>>

' -- Camada 3: Dados (MongoDB) --
' Posicionados logo abaixo dos serviços para indicar pertença
database "Mongo DB\n(Read Model)" as DB_Phys
database "Mongo DB\n(Read Model)" as DB_Pat
database "Mongo DB\n(Read Model)" as DB_Rec

' -- Camada 4: Infraestrutura Partilhada --
rectangle "Infraestrutura Partilhada" {
    rectangle "Message Broker\n(RabbitMQ)" as Broker <<Infra>>
    rectangle "Tracing\n(Zipkin)" as Zipkin <<Infra>>
}

' -- Alinhamentos Horizontais (Hidden) para forçar o layout --
Physicians -[hidden]r- Patients
Patients -[hidden]r- Records

DB_Phys -[hidden]r- DB_Pat
DB_Pat -[hidden]r- DB_Rec

' -- Conexões HTTP (Topo) --
Physicians -u-> Auth : HTTP
Patients -u-> Auth : HTTP
Records -u-> Auth : HTTP

Physicians <--> Patients : HTTP
Physicians <--> Records : HTTP
Records <--> Patients : HTTP

' -- Conexões de Base de Dados (Verticais Curtas) --
Physicians -d-> DB_Phys : Grava/Lê
Patients -d-> DB_Pat : Grava/Lê
Records -d-> DB_Rec : Grava/Lê

' -- Conexões Assíncronas (AMQP) --
' As linhas passam "por trás" ou ao lado das DBs
Physicians -[#D08770,dashed]d-> Broker : Pub
Patients -[#D08770,dashed]d-> Broker : Pub
Records -[#D08770,dashed]d-> Broker : Pub

Broker -[#D08770,dotted]u-> Physicians : Sub
Broker -[#D08770,dotted]u-> Patients : Sub
Broker -[#D08770,dotted]u-> Records : Sub

' -- Tracing (Mantido discreto) --
' Nota: Liguei às DBs visualmente ou aos serviços para limpar
Physicians -[#D8DEE9]d-> Zipkin
Patients -[#D8DEE9]d-> Zipkin
Auth -[#D8DEE9]d-> Zipkin
Records -[#D8DEE9]d-> Zipkin

legend right
  <color:#4C566A>───</color>  **HTTP** (Síncrono)
  <color:#4C566A>═══</color>  **Database** (Persistência)
  <color:#D08770>- - -</color>  **AMQP** (Pub - Escrita)
  <color:#D08770>......</color>  **AMQP** (Sub - Leitura)
  <color:#D8DEE9>───</color>  Zipkin
endlegend
@enduml