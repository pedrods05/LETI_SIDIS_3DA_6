@startuml

title US08 - SD - View Appointment History with Details
autoactivate on
autonumber

actor "Authenticated Patient"
participant ":controller:AppointmentHistoryController" as HistoryController
participant ":helper:AuthHelper" as AuthHelper
participant ":service:AppointmentService" as AppointmentService
participant ":repo:AppointmentRepository" as AppointmentRepository
participant ":repo:AppointmentRecordRepository" as RecordRepository
participant ":mapper:AppointmentHistoryMapper" as HistoryMapper

activate "Authenticated Patient"

"Authenticated Patient" -> HistoryController : GET /api/patients/me/appointments/history
HistoryController -> AuthHelper : getCurrentPatientId()
AuthHelper --> HistoryController : patientId

HistoryController -> AppointmentService : getCompletedAppointmentsWithDetails(patientId)

AppointmentService -> AppointmentRepository : findByPatientIdAndStatus(patientId, COMPLETED)
AppointmentRepository --> AppointmentService : List<Appointment>

loop for each Appointment
  AppointmentService -> RecordRepository : findByAppointmentId(appointmentId)
  RecordRepository --> AppointmentService : Optional<AppointmentRecord>
end

AppointmentService -> HistoryMapper : toDtoList(appointments, records)
HistoryMapper --> AppointmentService : List<AppointmentHistoryDTO>

AppointmentService --> HistoryController : List<AppointmentHistoryDTO>
HistoryController --> "Authenticated Patient" : 200 OK

deactivate "Authenticated Patient"

@enduml
