@startuml
title US07 - SD - Schedule an Appointment as a Patient
autoactivate on
autonumber

actor "Authenticated Patient"
participant ":controller:AppointmentController" as AppointmentController
participant ":service:AppointmentService" as AppointmentService
participant ":repo:PhysicianRepository" as PhysicianRepository
participant ":repo:AppointmentRepository" as AppointmentRepository
participant ":mapper:AppointmentMapper" as AppointmentMapper

activate "Authenticated Patient"

"Authenticated Patient" -> AppointmentController : POST /api/patients/appointments

AppointmentController -> AppointmentService : scheduleAppointment(dto, token)

AppointmentService -> PhysicianRepository : findById(dto.physicianId)
PhysicianRepository --> AppointmentService : Physician?

alt physician not found
  AppointmentService --> AppointmentController : 404 Not Found
  AppointmentController --> "Authenticated Patient" : 404 Not Found
  deactivate "Authenticated Patient"
else
  AppointmentService -> AppointmentService : validateWorkingHoursAndSlot(dto.dateTime)
  AppointmentService -> AppointmentRepository : existsByPhysicianAndDateTime(dto.physicianId, dto.dateTime)
  AppointmentRepository --> AppointmentService : Boolean (conflict)

  alt conflict found
    AppointmentService --> AppointmentController : 409 Conflict
    AppointmentController --> "Authenticated Patient" : 409 Conflict
    deactivate "Authenticated Patient"
  else
    AppointmentService -> AppointmentService : getPatientFromToken(token)
    AppointmentService -> AppointmentMapper : toDomain(dto, patient, physician)
    AppointmentMapper --> AppointmentService : Appointment

    AppointmentService -> AppointmentRepository : save(Appointment)
    AppointmentRepository --> AppointmentService : Appointment (with ID)

    AppointmentService --> AppointmentController : AppointmentIdResponse
    AppointmentController --> "Authenticated Patient" : 201 Created
    deactivate "Authenticated Patient"
  end
end
@enduml
