@startuml
title US11 - SD - Schedule an Appointment
autoactivate on
autonumber

actor "Administrator"
participant ":controller:AppointmentController" as AppointmentController
participant ":service:AppointmentService" as AppointmentService
participant ":repo:PatientRepository" as PatientRepository
participant ":repo:PhysicianRepository" as PhysicianRepository
participant ":repo:AppointmentRepository" as AppointmentRepository
participant ":mapper:AppointmentMapper" as AppointmentMapper

activate Administrator

Administrator -> AppointmentController : POST /api/appointments

AppointmentController -> AppointmentService : scheduleAppointment(dto)

AppointmentService -> PatientRepository : findById(dto.patientId)
PatientRepository --> AppointmentService : Patient?

AppointmentService -> PhysicianRepository : findById(dto.physicianId)
PhysicianRepository --> AppointmentService : Physician?

alt patient or physician not found
  AppointmentService --> AppointmentController : 404 Not Found
else
  AppointmentService -> AppointmentRepository : existsByPhysicianAndDateTime(dto.physicianId, dto.dateTime)
  AppointmentRepository --> AppointmentService : Boolean (conflict)

  alt conflict found
    AppointmentService --> AppointmentController : 409 Conflict
  else
    AppointmentService -> AppointmentMapper : toDomain(dto, patient, physician)
    AppointmentMapper --> AppointmentService : Appointment

    AppointmentService -> AppointmentRepository : save(Appointment)
    AppointmentRepository --> AppointmentService : Appointment (with ID)

    AppointmentService --> AppointmentController : AppointmentIdResponse
    AppointmentController --> Administrator : 201 Created
  end
end

deactivate Administrator
@enduml
