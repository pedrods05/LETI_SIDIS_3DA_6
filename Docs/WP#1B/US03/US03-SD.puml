@startuml
title US03 - SD - View available appointment slots for a physician
autoactivate on
autonumber

actor "Patient"
participant ":controller:AppointmentController" as AppointmentController
participant ":service:AppointmentService" as AppointmentService
participant ":repo:PhysicianRepository" as PhysicianRepository
participant ":repo:AppointmentRepository" as AppointmentRepository
participant ":service:SlotCalculator" as SlotCalculator
participant ":mapper:SlotMapper" as SlotMapper

activate Patient

Patient -> AppointmentController : GET /api/appointments/physicians/{id}/slots?start=YYYY-MM-DD
note right: @PreAuthorize("hasAuthority('PATIENT')")

AppointmentController -> AppointmentService : getAvailableSlots(physicianId, startDate)

AppointmentService -> PhysicianRepository : findById(physicianId)
PhysicianRepository --> AppointmentService : Physician

AppointmentService -> AppointmentRepository : findByPhysicianAndDateRange(physician, startDate, startDate + 10)
AppointmentRepository --> AppointmentService : List<Appointment>

AppointmentService -> SlotCalculator : generateAvailableSlots(physician, appointments, startDate, startDate + 10)
SlotCalculator --> AppointmentService : List<Slot>

AppointmentService -> SlotMapper : toDtoList(slots)
SlotMapper --> AppointmentService : List<AppointmentSlotDto>

AppointmentService --> AppointmentController : List<AppointmentSlotDto>
AppointmentController --> Patient : 200 OK

deactivate Patient
@enduml
