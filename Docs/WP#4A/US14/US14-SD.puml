@startuml
title US14 - SD - Record Appointment Details
autoactivate on
autonumber

actor "Physician"
participant ":controller:AppointmentRecordController" as RecordController
participant ":helper:AuthHelper" as AuthHelper
participant ":service:AppointmentRecordService" as RecordService
participant ":repo:AppointmentRepository" as AppointmentRepository
participant ":repo:AppointmentRecordRepository" as RecordRepository
participant ":mapper:AppointmentRecordMapper" as RecordMapper

activate Physician

Physician -> RecordController : POST /api/appointment-records/id/record
RecordController -> AuthHelper : getCurrentUser()
AuthHelper --> RecordController : User (role, id)
RecordController -> RecordService : createRecord(appointmentId, dto, physicianId)

RecordService -> AppointmentRepository : findById(appointmentId)
AppointmentRepository --> RecordService : Optional<Appointment>

RecordService -> RecordMapper : toDomain(dto)
RecordMapper --> RecordService : AppointmentRecord

RecordService -> RecordRepository : save(AppointmentRecord)
RecordRepository --> RecordService : AppointmentRecord (with ID)

RecordService --> RecordController : RecordCreatedResponse
RecordController --> Physician : 201 Created
deactivate Physician

alt appointment not found
  RecordService --> RecordController : 404 Not Found
  RecordController --> Physician : 404 Not Found
  deactivate Physician
end

alt user.role != PHYSICIAN
  RecordController --> Physician : 403 Forbidden
  deactivate Physician
end
@enduml
